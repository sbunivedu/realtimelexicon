<!DOCTYPE HTML>
<html>

<head>
  <!-- when using the mode "code", it's important to specify charset utf-8 -->
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">

  <link href="jsoneditor.css" rel="stylesheet" type="text/css">
  <script src="jsoneditor.js"></script>
  <script src="sharedb.js"></script>
  <script src="channel/bcsocket.js"></script>
</head>

<body>
  <div id="jsoneditor" style="width: 400px; height: 300px;"></div>

  <form>
    Path:
    <br>
    <input id="path" name="Path:">
    <br> Content to be deleted:
    <br>
    <input id="delete" name="Content to be deleted:">
    <br> Content to be inserted:
    <br>
    <input id="insert" name="Content to be inserted:">
    <br>
    <button type="button" id="simpleButton">Make Simple Change</button>
    <button type="button" id="arrayButton">Make Array Change</button>
  </form>

  <script>
    var socket = new BCSocket('/channel');
    var connection = new window.sharedb.Connection(socket);
    var doc = connection.get("temporary", "hello-world-document");
    doc.subscribe(function(error) {
      if (error) {
        console.log("Failed to subscribe.", error);
      }
      if (!doc.type) {
        doc.create({
          x: "hello"
        });
        console.log('add {x: "hello"}');
      }

      /////////////////////////////////////////////////////////////////////////
      /////////////////////////////////New Code////////////////////////////////
      /////////////////////////////////////////////////////////////////////////
      //Most Helpful Files:
      //https://github.com/share/ShareJS/wiki/0.7-JSON-Client-API
      //https://github.com/ottypes/json0
      /////////////////////////////////////////////////////////////////////////
      var path = document.getElementById('path');
      var del = document.getElementById('delete');
      var ins = document.getElementById('insert');

      document.getElementById('simpleButton').onclick = function() {
        simpleButtonClick()
      };

      document.getElementById('arrayButton').onclick = function() {
        arrayButtonClick()
      };

      //This works on one-tier objects.
      function simpleButtonClick() {
        doc.submitOp([{p: [path.value],od: del.value, oi: ins.value}]);
      }

      var splitPath;
      var intPath;
      var endPath;
      function arrayButtonClick() {

        console.log("path.value is " + path.value);
        splitPath = path.value.split(",");
        splitPath.forEach(function(item, index, array) {
          //source for if statement is in a comment for top voted answer here:
          //http://stackoverflow.com/questions/175739/is-there-a-built-in-way-in-javascript-to-check-if-a-string-is-a-valid-number
          if (+item === +item) {  //if it's a number
            array[index] = +item; //convert the array elem to number
          }
        });

        //start to build the operation object
        var op = {p: splitPath};

        if (del.value) {
          op.ld = del.value;
        }

        if (ins.value) {
          op.li = ins.value;
        }

        console.log("op is:", JSON.stringify(op));
        doc.submitOp([op]);
      }
      /////////////////////////////////////////////////////////////////////////
      ///////////////////////////End New Code//////////////////////////////////
      /////////////////////////////////////////////////////////////////////////

      // create the editor
      var container = document.getElementById("jsoneditor");
      setTimeout(function() {
        var editor = new JSONEditor(container, {
          onChange: function(type, change) {
            doc.submitOp([{
              p: [],
              od: doc.data,
              oi: editor.get()
            }], true);
          }
        }, doc.data);
        doc.on('op', function(op, local) {
          if (!local) {
            console.log("op:", op);
            console.log("doc.data:", doc.data);
            editor.set(doc.data);
          }
        });
      }, 2000);
    });
  </script>
</body>

</html>
